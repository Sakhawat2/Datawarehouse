<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>üì° My Sensor Data | User Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f5f7fa; font-family: 'Inter', sans-serif; }
    .navbar { background: #0d6efd; color: #fff; }
    .navbar a { color: #fff; text-decoration: none; }
    .card { border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .table th { background-color: #0d6efd; color: #fff; text-align: center; }
    .logout-btn { color: white; border: 1px solid white; }
    .chart-container { position: relative; margin: 0 auto; max-width: 400px; }
    h1 { font-weight: 700; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg px-3">
    <div class="container-fluid">
      <span class="navbar-brand">üì¶ Data Warehouse</span>
      <div>
        <span id="welcomeUser" class="me-3"></span>
        <button class="btn btn-sm logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>üì° My Sensor Overview</h1>
      <div>
        <a href="/user/user.html" class="btn btn-outline-primary btn-sm">‚Üê Dashboard</a>
      </div>
    </div>

    <!-- Sensor Select + Export -->
    <div class="d-flex align-items-center mb-3">
      <label class="fw-semibold me-2">Select Sensor:</label>
      <select id="sensorSelect" class="form-select w-auto me-2"></select>
      <button id="refreshBtn" class="btn btn-primary btn-sm me-2">üîÑ Refresh</button>
      <button id="exportBtn" class="btn btn-outline-success btn-sm">üì§ Export CSV</button>
    </div>

    <!-- Chart + Stats -->
    <div class="row g-3 mb-4">
      <div class="col-md-8">
        <div class="card p-3">
          <h5>üìà My Sensor Data Over Time</h5>
          <div class="chart-container">
            <canvas id="sensorChart"></canvas>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3">
          <h5>üìä Sensor Statistics</h5>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">Latest Value: <b id="latestValue">‚Äì</b></li>
            <li class="list-group-item">Average Value: <b id="avgValue">‚Äì</b></li>
            <li class="list-group-item">Minimum Value: <b id="minValue">‚Äì</b></li>
            <li class="list-group-item">Maximum Value: <b id="maxValue">‚Äì</b></li>
            <li class="list-group-item">Total Records: <b id="totalRecords">‚Äì</b></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Add Sensor Reading -->
    <div class="card p-3 mb-4">
      <h5>‚ûï Add New Sensor Reading</h5>
      <form id="addReadingForm" class="row g-2 align-items-center">
        <div class="col-md-3">
          <input type="text" id="sensorName" class="form-control" placeholder="Sensor Name" required />
        </div>
        <div class="col-md-2">
          <input type="number" id="sensorValue" class="form-control" placeholder="Value" required />
        </div>
        <div class="col-md-2">
          <input type="text" id="sensorUnit" class="form-control" placeholder="Unit (e.g. ¬∞C)" />
        </div>
        <div class="col-md-3">
          <input type="datetime-local" id="timestamp" class="form-control" required />
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-success w-100">Add</button>
        </div>
      </form>
    </div>

    <!-- Table -->
    <div class="card p-3">
      <h5>üìã My Sensor Readings</h5>
      <div class="table-responsive">
        <table class="table table-bordered table-striped mt-2">
          <thead>
            <tr>
              <th>Sensor</th>
              <th>Start Time</th>
              <th>End Time</th>
              <th>Value</th>
              <th>Unit</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="sensorTableBody">
            <tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // --- Auth ---
    const token = localStorage.getItem("token");
    const username = localStorage.getItem("username");
    if (!token) {
      alert("Your session has expired. Please log in again.");
      window.location.href = "/admin/login.html";
    }

    const authHeader = { Authorization: `Bearer ${token}` };
    document.getElementById("welcomeUser").innerText = `üë§ ${username || ""}`;

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "/admin/login.html";
    });

    let chart;
    const fmt = s => s ? new Date(s).toLocaleString() : "-";

    // --- Load Sensors (only for current user) ---
    async function loadSensors() {
      try {
        const res = await fetch("/api/user/sensors", { headers: authHeader });
        if (!res.ok) {
          console.warn("Failed to fetch user sensors:", res.status);
          return;
        }

        const data = await res.json();
        const sensors = Array.isArray(data) ? data : data.sensors || [];
        const sel = document.getElementById("sensorSelect");
        sel.innerHTML = sensors.map(s => `<option value="${s.id}">${s.name}</option>`).join("");

        if (sensors.length) {
          loadSensorData(sensors[0].id);
        } else {
          sel.innerHTML = `<option disabled selected>No sensors available</option>`;
          renderTable([]);
          if (chart) chart.destroy();
        }
      } catch (err) {
        console.error("‚ùå Error loading user sensors:", err);
      }
    }

    // --- Load Sensor Data ---
    async function loadSensorData(sensorId) {
  if (!sensorId) return;
  const res = await fetch(`/api/sensors/${sensorId}/readings`, { headers: authHeader });
  if (!res.ok) return;
  const rows = await res.json();
  console.log("‚úÖ Received rows:", rows); // üëà ADD THIS
  if (!Array.isArray(rows) || !rows.length) {
    console.warn("‚ö†Ô∏è No readings found for this sensor.");
    renderTable([]);
    if (chart) chart.destroy();
    return;
  }
  renderTable(rows);
  renderChart(rows);
}


    // --- Render Chart & Stats ---
    function renderChart(rows) {
      const labels = rows.map(r => fmt(r.start_time));
      const values = rows.map(r => parseFloat(r.value));


      if (chart) chart.destroy();
      const ctx = document.getElementById("sensorChart").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "Sensor Value",
            data: values,
            borderColor: "#0d6efd",
            borderWidth: 2,
            tension: 0.3
          }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });

      if (values.length) {
        document.getElementById("latestValue").textContent = values.at(-1);
        document.getElementById("avgValue").textContent = (values.reduce((a,b)=>a+b,0)/values.length).toFixed(2);
        document.getElementById("minValue").textContent = Math.min(...values);
        document.getElementById("maxValue").textContent = Math.max(...values);
        document.getElementById("totalRecords").textContent = values.length;
      }
    }

    // --- Render Table ---
    function renderTable(rows) {
      const tbody = document.getElementById("sensorTableBody");
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No readings.</td></tr>`;
        return;
      }
      tbody.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.sensor_name || r.sensor?.name || "-"}</td>
          <td>${fmt(r.start_time || r.ts)}</td>
          <td>${fmt(r.end_time || r.ts_end)}</td>
          <td>${r.value}</td>
          <td>${r.unit || "-"}</td>
          <td>
            <button class="btn btn-sm btn-warning me-1" onclick="editReading('${r.id}', ${r.value}, '${r.unit}')">‚úèÔ∏è Edit</button>
            <button class="btn btn-sm btn-danger" onclick="deleteReading('${r.id}')">üóëÔ∏è Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // --- Add Reading ---
    document.getElementById("addReadingForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = new FormData();
      form.append("sensor_name", document.getElementById("sensorName").value);
      form.append("value", document.getElementById("sensorValue").value);
      form.append("unit", document.getElementById("sensorUnit").value);
      form.append("ts", document.getElementById("timestamp").value);
      const res = await fetch("/api/sensors/add", { method: "POST", headers: authHeader, body: form });
      if (res.ok) {
        e.target.reset();
        loadSensors();
      } else alert("‚ùå Failed to add reading.");
    });

    // --- Edit Reading ---
    async function editReading(id, oldValue, oldUnit) {
      const newValue = prompt("Enter new value:", oldValue);
      if (newValue === null) return;
      const newUnit = prompt("Enter new unit:", oldUnit);
      if (newUnit === null) return;
      const fd = new FormData();
      fd.append("value", newValue);
      fd.append("unit", newUnit);
      const res = await fetch(`/api/sensors/update/${id}`, { method: "PUT", headers: authHeader, body: fd });
      if (res.ok) loadSensors();
      else alert("Failed to update reading.");
    }

    // --- Delete Reading ---
    async function deleteReading(id) {
      if (!confirm("Delete this reading?")) return;
      const res = await fetch(`/api/sensors/delete/${id}`, { method: "DELETE", headers: authHeader });
      if (res.ok) loadSensors();
      else alert("Failed to delete reading.");
    }

    // --- Export CSV ---
    document.getElementById("exportBtn").addEventListener("click", () => {
      const sel = document.getElementById("sensorSelect");
      if (!sel.value) return alert("Select a sensor first!");
      const start = new Date(Date.now() - 7*24*60*60*1000).toISOString(); // last 7 days
      const end = new Date().toISOString();
      window.open(`/api/export/sensor-data?sensor_ids=${sel.value}&start=${start}&end=${end}`);
    });

    document.getElementById("sensorSelect").addEventListener("change", e => loadSensorData(e.target.value));
    document.getElementById("refreshBtn").addEventListener("click", () => loadSensors());

    loadSensors();
  </script>
</body>
</html>
