<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>👤 User Dashboard | Data Warehouse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
    .navbar { background: #0d6efd; color: #fff; }
    .navbar a { color: #fff; text-decoration: none; }
    h1 { font-weight: 700; color: #0d6efd; }
    .card { border: none; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
    .btn-nav { margin-right: 8px; }
    .chart-container { height: 260px; }
    footer { text-align: center; color: gray; font-size: 0.9em; margin-top: 25px; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg px-3">
    <div class="container-fluid">
      <span class="navbar-brand">📦 Data Warehouse</span>
      <div>
        <span id="welcomeUser" class="me-3"></span>
        <button class="btn btn-sm logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>


  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1>📊 User Dashboard</h1>
      <div>
        <a href="/user/sensors.html" class="btn btn-outline-success btn-sm btn-nav">📡 Sensors</a>
        <a href="/user/files.html" class="btn btn-outline-primary btn-sm btn-nav">📁 Files</a>
        
      </div>
    </div>

    <p class="text-muted">Overview of your personal storage, sensors, videos, and readings.</p>

    <!-- Top summary cards -->
    <div class="row g-3 mb-4">
      <div class="col-md-3"><div class="card p-3 text-center"><h6>Total Storage (MB)</h6><h3 id="storageValue">0</h3></div></div>
      <div class="col-md-3"><div class="card p-3 text-center"><h6>Total Sensors</h6><h3 id="sensorCount">0</h3></div></div>
      <div class="col-md-3"><div class="card p-3 text-center"><h6>Total Videos</h6><h3 id="videoCount">0</h3></div></div>
      <div class="col-md-3"><div class="card p-3 text-center"><h6>Avg Reading</h6><h3 id="avgReading">-</h3></div></div>
    </div>

    <!-- Charts Row -->
    <div class="row g-3">
      <div class="col-md-6">
        <div class="card p-3">
          <h6 class="text-center">📦 Storage Breakdown</h6>
          <div class="chart-container"><canvas id="storageChart"></canvas></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <h6 class="text-center">📈 Sensor Count</h6>
          <div class="chart-container"><canvas id="sensorChart"></canvas></div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card p-3">
          <h6 class="text-center">🎥 Video Count by Size</h6>
          <div class="chart-container"><canvas id="videoChart"></canvas></div>
        </div>
      </div>
    </div>

    <footer>Last updated: <span id="lastUpdated"></span></footer>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const username = localStorage.getItem("username");
    if (!token) {
      alert("Your session has expired. Please log in again.");
      window.location.href = "/admin/login.html";
    }

    const authHeader = { Authorization: `Bearer ${token}` };
    document.getElementById("welcomeUser").innerText = `👤 ${username || ""}`;

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "/admin/login.html";
    });

    let storageChart, sensorChart, videoChart;

    async function loadDashboard() {
      try {
        const [filesRes, sensorsRes, readingsRes] = await Promise.all([
          fetch("/api/files", { headers: authHeader }),
          fetch("/api/sensors", { headers: authHeader }),
          fetch("/api/sensors/all-readings", { headers: authHeader })
        ]);

        const files = await filesRes.json();
        const sensors = await sensorsRes.json();
        const readings = await readingsRes.json();

        // ---- Storage and file type breakdown ----
        const totals = { Documents: 0, Images: 0, Videos: 0, Others: 0 };
        files.forEach(f => {
          const ext = f.filename.split(".").pop().toLowerCase();
          const size = f.size || 0;
          if (["jpg","jpeg","png","gif"].includes(ext)) totals.Images += size;
          else if (["mp4","avi","mov","mkv"].includes(ext)) totals.Videos += size;
          else if (["pdf","docx","xlsx","txt","pptx"].includes(ext)) totals.Documents += size;
          else totals.Others += size;
        });

        const totalStorage = Object.values(totals).reduce((a,b)=>a+b,0);
        document.getElementById("storageValue").textContent = totalStorage.toFixed(2);
        document.getElementById("videoCount").textContent = files.filter(f => /\.(mp4|avi|mov|mkv)$/i.test(f.filename)).length;
        document.getElementById("sensorCount").textContent = sensors.length;

        // ---- Average reading ----
        if (Array.isArray(readings) && readings.length) {
          const avg = readings.reduce((sum, r) => sum + (r.value || 0), 0) / readings.length;
          document.getElementById("avgReading").textContent = avg.toFixed(2);
        } else {
          document.getElementById("avgReading").textContent = "-";
        }

        // ---- Charts ----
        const ctxStorage = document.getElementById("storageChart").getContext("2d");
        if (storageChart) storageChart.destroy();
        storageChart = new Chart(ctxStorage, {
          type: "pie",
          data: {
            labels: Object.keys(totals),
            datasets: [{ data: Object.values(totals), backgroundColor: ["#4e73df","#1cc88a","#36b9cc","#f6c23e"] }]
          },
          options: { plugins: { legend: { position: "bottom" } } }
        });

        const ctxSensor = document.getElementById("sensorChart").getContext("2d");
        if (sensorChart) sensorChart.destroy();
        sensorChart = new Chart(ctxSensor, {
          type: "bar",
          data: {
            labels: sensors.map(s => s.name || "Unnamed"),
            datasets: [{ label: "Readings", data: sensors.map(s => s.readings || 0), backgroundColor: "#1cc88a" }]
          },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });

        const ctxVideo = document.getElementById("videoChart").getContext("2d");
        if (videoChart) videoChart.destroy();
        const small = files.filter(f => f.size < 10).length;
        const medium = files.filter(f => f.size >= 10 && f.size < 100).length;
        const large = files.filter(f => f.size >= 100).length;
        videoChart = new Chart(ctxVideo, {
          type: "bar",
          data: {
            labels: ["Small (<10MB)", "Medium (10–100MB)", "Large (>100MB)"],
            datasets: [{ label: "Videos", data: [small, medium, large], backgroundColor: "#36b9cc" }]
          },
          options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });

        document.getElementById("lastUpdated").textContent = new Date().toLocaleString();
      } catch (err) {
        console.error("Error loading dashboard:", err);
        alert("Failed to load dashboard data.");
      }
    }

    loadDashboard();
  </script>
</body>
</html>
