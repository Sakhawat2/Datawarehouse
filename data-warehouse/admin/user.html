<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ‘¤ User Dashboard | Data Warehouse</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color: #f5f7fa; font-family: 'Inter', sans-serif; }
    .navbar { background: #0d6efd; color: #fff; }
    .navbar a { color: #fff; text-decoration: none; }
    .card { border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .table th { background-color: #0d6efd; color: #fff; }
    .logout-btn { color: white; border: 1px solid white; }
    .chart-container { position: relative; margin: 0 auto; max-width: 400px; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg px-3">
    <div class="container-fluid">
      <span class="navbar-brand">ğŸ“¦ Data Warehouse</span>
      <div>
        <span id="welcomeUser" class="me-3"></span>
        <button class="btn btn-sm logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <h3 class="mb-4 text-primary">ğŸ‘‹ Welcome to Your Dashboard</h3>

    <div class="row g-3">
      <!-- Quick Stats -->
      <div class="col-md-4">
        <div class="card p-3">
          <h5>ğŸ“Š Quick Stats</h5>
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between"><span>My Files</span><span id="fileCount">0</span></li>
            <li class="list-group-item d-flex justify-content-between"><span>My Videos</span><span id="videoCount">0</span></li>
            <li class="list-group-item d-flex justify-content-between"><span>Total Readings</span><span id="readingCount">0</span></li>
          </ul>
        </div>
      </div>

      <!-- Upload -->
      <div class="col-md-8">
        <div class="card p-3">
          <h5>ğŸ“¤ Upload New File or Video</h5>
          <form id="uploadForm" class="d-flex gap-2 align-items-center flex-wrap">
            <input type="file" id="fileInput" class="form-control" required />
            <button type="submit" class="btn btn-success">Upload</button>
          </form>
          <small class="text-muted mt-2 d-block">Files are private â€” only you (and admins) can see them.</small>
        </div>
      </div>
    </div>

    <!-- Chart -->
    <div class="card p-3 mt-4 text-center">
      <h5>ğŸ“ˆ My Storage Usage (Docs vs Videos)</h5>
      <div class="chart-container">
        <canvas id="storageChart"></canvas>
      </div>
    </div>

    <!-- Files -->
    <div class="card p-3 mt-4">
      <h5>ğŸ“ My Files & Videos</h5>
      <div class="table-responsive">
        <table class="table table-striped table-bordered mt-2">
          <thead>
            <tr>
              <th>Filename</th>
              <th>Type</th>
              <th>Size (MB)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="filesTableBody">
            <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const username = localStorage.getItem("username");
    if (!token) {
      alert("Your session has expired. Please log in again.");
      window.location.href = "/admin/login.html";
    }

    const authHeader = { Authorization: `Bearer ${token}` };
    document.getElementById("welcomeUser").innerText = `ğŸ‘¤ ${username || ""}`;

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "/admin/login.html";
    });

    let storageChart;

    async function loadUserDashboard() {
      try {
        const [filesRes, readingsRes] = await Promise.all([
          fetch("/api/files", { headers: authHeader }),
          fetch("/api/sensors/all-readings"),
        ]);

        const files = await filesRes.json();
        const readings = await readingsRes.json();

        const videoFiles = files.filter(f => /\.(mp4|avi|mov|mkv)$/i.test(f.filename));
        const docFiles = files.filter(f => !/\.(mp4|avi|mov|mkv)$/i.test(f.filename));

        document.getElementById("fileCount").textContent = docFiles.length;
        document.getElementById("videoCount").textContent = videoFiles.length;
        document.getElementById("readingCount").textContent = readings.length;

        const tbody = document.getElementById("filesTableBody");
        tbody.innerHTML = "";
        files.forEach(f => {
          const type = /\.(mp4|avi|mov|mkv)$/i.test(f.filename) ? "ğŸ¥ Video" : "ğŸ“„ Document";
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${f.filename}</td>
            <td>${type}</td>
            <td>${(f.size || 0).toFixed(2)}</td>
            <td>
              <a href="/api/files/download/${f.filename}" class="btn btn-sm btn-primary">â¬‡ï¸ Download</a>
              <button class="btn btn-sm btn-danger" onclick="deleteFile('${f.filename}')">ğŸ—‘ï¸ Delete</button>
            </td>`;
          tbody.appendChild(tr);
        });

        const totalDocSize = docFiles.reduce((a,b) => a + (b.size || 0), 0);
        const totalVideoSize = videoFiles.reduce((a,b) => a + (b.size || 0), 0);
        drawStorageChart(totalDocSize, totalVideoSize);
      } catch (err) {
        console.error("Error loading user dashboard:", err);
      }
    }

    function drawStorageChart(docSize, videoSize) {
      const ctx = document.getElementById("storageChart").getContext("2d");
      if (storageChart) storageChart.destroy();
      storageChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: ["Documents", "Videos"],
          datasets: [{
            data: [docSize, videoSize],
            backgroundColor: ["#4e73df", "#36b9cc"]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1.5,
          plugins: {
            legend: { position: "bottom" },
          },
        }
      });
    }

    async function deleteFile(filename) {
      if (!confirm(`Delete ${filename}?`)) return;
      await fetch(`/api/files/delete/${filename}`, {
        method: "DELETE",
        headers: authHeader
      });
      loadUserDashboard();
    }
    window.deleteFile = deleteFile;

    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById("fileInput");
      if (!fileInput.files.length) return;
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      await fetch("/api/files/upload", {
        method: "POST",
        headers: authHeader,
        body: formData,
      });
      fileInput.value = "";
      loadUserDashboard();
    });

    loadUserDashboard();
  </script>
</body>
</html>
