<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üìÅ Documents & Photos | Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Inter', sans-serif;
    }
    h1 {
      font-weight: 700;
    }
    .card {
      border: none;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }
    .table th {
      background: #0d6efd;
      color: #fff;
      text-align: center;
    }
    .table td {
      text-align: center;
      vertical-align: middle;
    }
    .btn-sm {
      padding: 3px 10px;
    }
    .chart-container {
      position: relative;
      margin: 0 auto;
      max-width: 400px;
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1>üìÇ Documents & Photos</h1>
      <div>
        <a href="/admin/index.html" class="btn btn-outline-primary btn-sm">‚Üê Back to Dashboard</a>
        <button class="btn btn-outline-danger btn-sm ms-2" id="logoutBtn">üö™ Logout</button>
      </div>
    </div>

    <!-- Upload -->
    <div class="card p-3 mb-4">
      <h5>üì§ Upload New File</h5>
      <form id="uploadForm" class="d-flex gap-2 align-items-center flex-wrap">
        <input type="file" id="fileInput" class="form-control" required>
        <button type="submit" class="btn btn-success">Upload</button>
      </form>
    </div>

    <!-- Uploaded Files -->
    <div class="card p-3 mb-4">
      <h5>üìÑ Uploaded Files</h5>
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle mt-2">
          <thead>
            <tr>
              <th>Filename</th>
              <th>Preview</th>
              <th>Type</th>
              <th>Size (MB)</th>
              <th>Uploaded By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="filesTableBody">
            <tr><td colspan="6" class="text-center text-muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- File Storage Breakdown -->
    <div class="card p-3 text-center">
      <h5>üìä File Storage Breakdown</h5>
      <div class="chart-container">
        <canvas id="storageChart"></canvas>
      </div>
    </div>
  </div>

  <script>
    const token = localStorage.getItem("token");
    const authHeader = { Authorization: `Bearer ${token}` };

    if (!token) {
      alert("Session expired. Please log in again.");
      window.location.href = "/admin/login.html";
    }

    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.clear();
      window.location.href = "/admin/login.html";
    });

    let storageChart;

    // Load all files (admin sees all)
    async function loadFiles() {
      try {
        const res = await fetch("/api/files", { headers: authHeader });
        if (!res.ok) {
          console.error("Failed to fetch file list:", res.status);
          alert("‚ö†Ô∏è Failed to fetch files list");
          return;
        }

        const files = await res.json();
        const tableBody = document.getElementById("filesTableBody");
        tableBody.innerHTML = "";

        if (!files.length) {
          tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">No files uploaded yet.</td></tr>`;
          updateChart({});
          return;
        }

        // Categorize files for chart
        const typeGroups = { Documents: 0, Images: 0, Videos: 0, Others: 0 };

        files.forEach(f => {
          const ext = f.filename.split(".").pop().toLowerCase();
          let type = "Others";
          if (["jpg", "jpeg", "png", "gif"].includes(ext)) type = "Images";
          else if (["mp4", "avi", "mov", "mkv"].includes(ext)) type = "Videos";
          else if (["pdf", "docx", "xlsx", "txt", "pptx"].includes(ext)) type = "Documents";

          typeGroups[type] += f.size || 0;

          const fileUrl = `/uploaded_files/${f.username}/${f.filename}`;
          let previewHTML = "-";
          if (type === "Images") previewHTML = `<img src="${fileUrl}" width="60" height="40" style="object-fit:cover;border-radius:6px;">`;
          else if (type === "Videos") previewHTML = `<video src="${fileUrl}" width="80" height="50" controls></video>`;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${f.filename}</td>
            <td>${previewHTML}</td>
            <td>${type}</td>
            <td>${(f.size || 0).toFixed(2)}</td>
            <td>${f.username || "-"}</td>
            <td>
              <a href="/api/files/download/${f.filename}" class="btn btn-sm btn-primary">‚¨áÔ∏è Download</a>
              <button class="btn btn-sm btn-danger" onclick="deleteFile('${f.filename}')">üóëÔ∏è Delete</button>
            </td>`;
          tableBody.appendChild(tr);
        });

        updateChart(typeGroups);
      } catch (err) {
        console.error("Error loading files:", err);
      }
    }

    // Upload File
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById("fileInput");
      if (!fileInput.files.length) return;

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      try {
        const res = await fetch("/api/files/upload", {
          method: "POST",
          headers: authHeader,
          body: formData,
        });

        if (res.ok) {
          alert("‚úÖ File uploaded successfully!");
          fileInput.value = "";
          loadFiles();
        } else {
          const errText = await res.text();
          console.error("Upload failed:", res.status, errText);
          alert("‚ùå Failed to upload file.");
        }
      } catch (err) {
        console.error("Upload error:", err);
      }
    });

    // Delete File
    async function deleteFile(filename) {
      if (!confirm(`üóëÔ∏è Delete ${filename}?`)) return;
      try {
        const res = await fetch(`/api/files/delete/${filename}`, {
          method: "DELETE",
          headers: authHeader,
        });
        if (res.ok) {
          alert("‚úÖ File deleted successfully!");
          loadFiles();
        } else {
          alert("‚ùå Failed to delete file.");
        }
      } catch (err) {
        console.error("Delete error:", err);
      }
    }

    // Update Chart
    function updateChart(typeGroups) {
      const ctx = document.getElementById("storageChart").getContext("2d");
      if (storageChart) storageChart.destroy();
      storageChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: Object.keys(typeGroups),
          datasets: [{
            data: Object.values(typeGroups),
            backgroundColor: ["#4e73df", "#1cc88a", "#36b9cc", "#f6c23e"],
          }],
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1.5,
          plugins: {
            legend: { position: "bottom" },
          },
        },
      });
    }

    loadFiles();
  </script>
</body>
</html>
